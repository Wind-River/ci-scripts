# Copyright (c) 2017 Wind River Systems Inc.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

version: '3.1'
services:
  jenkins:
    image: $REGISTRY/jenkins-master:$JENKINS_MASTER_TAG
    environment:
      JAVA_OPTS: '-Djenkins.install.runSetupWizard=false -Dhudson.slaves.WorkspaceList=_'
      JENKINS_OPTS: '--httpPort=8080 --httpListenAddress=0.0.0.0'
      JENKINS_UI_URL: "https://$HOST"
    links:
      - rproxy
    networks:
      - ci_net
    tmpfs:
      - /tmp:exec
    volumes:
      - jenkins_home:/var/jenkins_home

  rproxy:
    image: blacklabelops/nginx:${RPROXY_TAG:-latest}
    ports:
      - "443:443"
    environment:
      SERVER1HTTPS_ENABLED: "true"
      SERVER1HTTP_ENABLED: "false"
      SERVER1SERVER_NAME: "localhost"
      # Jenkins at root path so it can be accessed by workers path
      SERVER1REVERSE_PROXY_LOCATION1: "/"
      SERVER1REVERSE_PROXY_PASS1: "http://jenkins:8080"
      SERVER1REVERSE_PROXY_APPLICATION1: "jenkins"
      SERVER1REVERSE_PROXY_LOCATION2: "/toaster_aggregator"
      SERVER1REVERSE_PROXY_PASS2: "http://toaster_aggregator:6543"
      NGINX_REDIRECT_PORT80: "true"
      SERVER1CERTIFICATE_DNAME: "/CN=WindRiver/OU=Linux/O=windriver.com/L=Alameda/C=US"
      DISABLE_ACCESS_LOG: "true"
      LOG_LEVEL: "warn"
    networks:
      - ci_net
    tmpfs:
      - /tmp
    volumes:
      # Volume avoids recreating certs on every run
      - rproxy_nginx_config:/etc/nginx/keys

  client:
    image: $REGISTRY/jenkins-swarm-client:$JENKINS_AGENT_TAG
    depends_on:
      - jenkins
    environment:
      COMMAND_OPTIONS: "-master http://jenkins:8080/ -disableSslVerification -labels 'docker' -executors 2"
      SWARM_DELAYED_START: "15"
    networks:
      - ci_net
    tmpfs:
      - /tmp
    volumes:
      # Allow jenkins agent to use host docker to run containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Required to mount workspace from swarm client into docker container
      - jenkins_agent:/home/jenkins
      - /etc/hostname:/etc/hostname
      - /etc/localtime:/etc/localtime

  consul:
    image: consul:$CONSUL_TAG
    networks:
      - ci_net
    command: "agent -server -ui -bootstrap-expect=1 -client=0.0.0.0"

  registrator:
    image: gliderlabs/registrator:latest
    command: -ip=$HOSTIP consul://consul:8500
    networks:
      - ci_net
    depends_on:
      - consul
    links:
      - consul
    volumes:
      # Allow jenkins agent to use host docker to run containers
      - /var/run/docker.sock:/tmp/docker.sock
      - /etc/hostname:/etc/hostname

  toaster_aggregator:
    image: $REGISTRY/toaster_aggregator
    depends_on:
      - consul
    links:
      - rproxy
      - consul
    networks:
      - ci_net

volumes:
  jenkins_home:
  jenkins_agent:
  rproxy_nginx_config:

networks:
  ci_net:
    driver: bridge
